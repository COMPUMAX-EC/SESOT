{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SESOT - Sistema Experto</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    {% verbatim %}
    <script type="text/babel">
        // Iconos SVG directos (sin lucide)
        const WrenchIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
        );
        
        const SendIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );
        
        const PlusIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );
        
        const MessageSquareIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );
        
        const CpuIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                <rect x="9" y="9" width="6" height="6"></rect>
                <line x1="9" y1="1" x2="9" y2="4"></line>
                <line x1="15" y1="1" x2="15" y2="4"></line>
                <line x1="9" y1="20" x2="9" y2="23"></line>
                <line x1="15" y1="20" x2="15" y2="23"></line>
                <line x1="20" y1="9" x2="23" y2="9"></line>
                <line x1="20" y1="14" x2="23" y2="14"></line>
                <line x1="1" y1="9" x2="4" y2="9"></line>
                <line x1="1" y1="14" x2="4" y2="14"></line>
            </svg>
        );
        
        const SettingsIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m8.66-12-5.2 3M8.54 14l-5.2 3m12.12 0-5.2-3M8.54 10l-5.2-3"></path>
            </svg>
        );
        
        const MenuIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );
        
        const XIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );
        
        const SesotChatInterface = () => {
            const [conversations, setConversations] = React.useState([
                { id: 1, title: 'Nueva consulta', timestamp: new Date(), messages: [] }
            ]);
            const [currentConvId, setCurrentConvId] = React.useState(1);
            const [messages, setMessages] = React.useState([
                { 
                    id: 1, 
                    type: 'system', 
                    content: 'Â¡Bienvenido a SESOT! ðŸ”§\n\nSoy tu asistente experto en diagnÃ³stico de hardware. Puedo ayudarte con problemas de:\n\nðŸ–¥ï¸ Computadoras/CPU\nðŸ–¨ï¸ Impresoras\n\nÂ¿QuÃ© dispositivo necesitas diagnosticar?', 
                    timestamp: new Date() 
                }
            ]);
            const [inputText, setInputText] = React.useState('');
            const [isTyping, setIsTyping] = React.useState(false);
            const [sidebarOpen, setSidebarOpen] = React.useState(true);
            const messagesEndRef = React.useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleNewChat = () => {
                const newId = Date.now();
                const newConv = {
                    id: newId,
                    title: `Consulta ${new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}`,
                    timestamp: new Date(),
                    messages: []
                };
                setConversations([newConv, ...conversations]);
                setCurrentConvId(newId);
                setMessages([
                    { 
                        id: 1, 
                        type: 'system', 
                        content: 'Â¡Hola de nuevo! Â¿En quÃ© puedo ayudarte ahora?', 
                        timestamp: new Date() 
                    }
                ]);
            };

            const handleSendMessage = async () => {
                if (!inputText.trim()) return;

                const userMessage = {
                    id: Date.now(),
                    type: 'user',
                    content: inputText,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                const currentInput = inputText;
                setInputText('');
                setIsTyping(true);

                try {
                    const response = await fetch('/api/diagnose/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: currentInput })
                    });

                    const data = await response.json();

                    if (data.success) {
                        const systemResponse = {
                            id: Date.now() + 1,
                            type: 'assistant',
                            content: data.response.content,
                            device: data.response.device,
                            timestamp: new Date()
                        };
                        
                        setTimeout(() => {
                            setMessages(prev => [...prev, systemResponse]);
                            setIsTyping(false);
                        }, 800);
                    } else {
                        throw new Error(data.error || 'Error desconocido');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    const errorMessage = {
                        id: Date.now() + 1,
                        type: 'system',
                        content: 'âŒ Error de conexiÃ³n. Por favor, intenta nuevamente.',
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                    setIsTyping(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            const selectConversation = (convId) => {
                setCurrentConvId(convId);
                const conv = conversations.find(c => c.id === convId);
                if (conv && conv.messages.length > 0) {
                    setMessages(conv.messages);
                } else {
                    setMessages([
                        { 
                            id: 1, 
                            type: 'system', 
                            content: 'Â¡Hola de nuevo! Â¿En quÃ© puedo ayudarte?', 
                            timestamp: new Date() 
                        }
                    ]);
                }
            };

            return (
                <div className="flex h-screen bg-gray-50">
                    {/* Sidebar */}
                    <div className={`${sidebarOpen ? 'w-80' : 'w-0'} transition-all duration-300 bg-gray-900 text-white flex flex-col overflow-hidden`}>
                        <div className="p-4 border-b border-gray-700">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-2">
                                    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                        <div className="w-6 h-6"><WrenchIcon /></div>
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold">SESOT</h1>
                                        <p className="text-xs text-gray-400">Sistema Experto</p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setSidebarOpen(false)}
                                    className="lg:hidden p-1 hover:bg-gray-800 rounded"
                                >
                                    <div className="w-5 h-5"><XIcon /></div>
                                </button>
                            </div>
                            <button
                                onClick={handleNewChat}
                                className="w-full flex items-center gap-2 px-4 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors"
                            >
                                <div className="w-5 h-5"><PlusIcon /></div>
                                <span className="font-medium">Nueva Consulta</span>
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-3 space-y-2">
                            {conversations.map(conv => (
                                <button
                                    key={conv.id}
                                    onClick={() => selectConversation(conv.id)}
                                    className={`w-full text-left p-3 rounded-lg transition-colors ${
                                        currentConvId === conv.id
                                            ? 'bg-gray-800 border border-gray-600'
                                            : 'hover:bg-gray-800'
                                    }`}
                                >
                                    <div className="flex items-start gap-2">
                                        <div className="w-4 h-4 mt-1 flex-shrink-0"><MessageSquareIcon /></div>
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm font-medium truncate">{conv.title}</p>
                                            <p className="text-xs text-gray-400 mt-1">
                                                {conv.timestamp.toLocaleDateString('es-ES', { 
                                                    day: '2-digit', 
                                                    month: 'short',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </p>
                                        </div>
                                    </div>
                                </button>
                            ))}
                        </div>

                        <div className="p-4 border-t border-gray-700">
                            <button className="w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-800 rounded-lg transition-colors text-sm">
                                <div className="w-4 h-4"><SettingsIcon /></div>
                                <span>ConfiguraciÃ³n</span>
                            </button>
                        </div>
                    </div>

                    {/* Main Chat Area */}
                    <div className="flex-1 flex flex-col">
                        <div className="bg-white border-b border-gray-200 px-6 py-4 flex items-center gap-4">
                            {!sidebarOpen && (
                                <button
                                    onClick={() => setSidebarOpen(true)}
                                    className="p-2 hover:bg-gray-100 rounded-lg"
                                >
                                    <div className="w-5 h-5"><MenuIcon /></div>
                                </button>
                            )}
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                                    <div className="w-7 h-7"><CpuIcon /></div>
                                </div>
                                <div>
                                    <h2 className="text-lg font-semibold text-gray-900">Asistente de DiagnÃ³stico</h2>
                                    <p className="text-sm text-gray-500">Soporte tÃ©cnico de hardware</p>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {messages.map(message => (
                                <div
                                    key={message.id}
                                    className={`flex gap-4 ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                                >
                                    {message.type !== 'user' && (
                                        <div className="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                            <div className="w-5 h-5"><WrenchIcon /></div>
                                        </div>
                                    )}
                                    <div className={`max-w-3xl ${message.type === 'user' ? 'order-first' : ''}`}>
                                        <div
                                            className={`rounded-2xl px-5 py-4 ${
                                                message.type === 'user'
                                                    ? 'bg-blue-600 text-white'
                                                    : message.type === 'system'
                                                    ? 'bg-purple-50 text-purple-900 border border-purple-200'
                                                    : 'bg-white text-gray-900 border border-gray-200 shadow-sm'
                                            }`}
                                        >
                                            <p className="whitespace-pre-line leading-relaxed">{message.content}</p>
                                        </div>
                                        <p className="text-xs text-gray-400 mt-2 px-2">
                                            {message.timestamp.toLocaleTimeString('es-ES', { 
                                                hour: '2-digit', 
                                                minute: '2-digit' 
                                            })}
                                        </p>
                                    </div>
                                    {message.type === 'user' && (
                                        <div className="w-9 h-9 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center flex-shrink-0">
                                            <span className="text-sm font-bold text-white">TÃš</span>
                                        </div>
                                    )}
                                </div>
                            ))}

                            {isTyping && (
                                <div className="flex gap-4">
                                    <div className="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <div className="w-5 h-5"><WrenchIcon /></div>
                                    </div>
                                    <div className="bg-white border border-gray-200 rounded-2xl px-5 py-4 shadow-sm">
                                        <div className="flex gap-1">
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.15s'}}></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.3s'}}></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div ref={messagesEndRef} />
                        </div>

                        <div className="border-t border-gray-200 bg-white p-4">
                            <div className="max-w-4xl mx-auto">
                                <div className="flex gap-3 items-end">
                                    <div className="flex-1 bg-gray-50 border border-gray-300 rounded-2xl px-5 py-3 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-200 transition-all">
                                        <textarea
                                            value={inputText}
                                            onChange={(e) => setInputText(e.target.value)}
                                            onKeyDown={handleKeyPress}
                                            placeholder="Describe el problema de tu dispositivo..."
                                            className="w-full bg-transparent outline-none resize-none text-gray-900 placeholder-gray-400"
                                            rows="1"
                                        />
                                    </div>
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={!inputText.trim() || isTyping}
                                        className="w-12 h-12 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl flex items-center justify-center transition-colors flex-shrink-0"
                                    >
                                        <div className="w-5 h-5"><SendIcon /></div>
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-3 text-center">
                                    SESOT v1.0 - Sistema Experto en Soporte TÃ©cnico
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SesotChatInterface />, document.getElementById('root'));
    </script>
    {% endverbatim %}
</body>
</html>